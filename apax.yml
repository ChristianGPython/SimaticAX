# General information
name: "myfirstproject"
version: 0.0.1
type: app
# Description of your application.
description: <Description for your application example or app>
# Targets for the 'apax build' command.
targets:
  - "1500"
  - llvm

# Catalog:
catalogs:
  "@ax/simatic-ax": ^2510.0.0
# Dependencies
devDependencies:
  "@ax/sdk": ^2510.0.0

# Project variables
variables:
  APAX_BUILD_ARGS:
    - --debug # Enable debug information for value debugging.

  # Folder where to find the compiled HW artifacts.
  HW_BIN_FOLDER: ./hwbin

  # Folder where to find the compiled SW artifacts.
  SW_BIN_FOLDER: "./bin/1500"

  # IP address must match with the IP address of your target device.
  # The IP address in the '/.vscode/launch.json' must be equal. 
  IP_ADDRESS: "192.168.0.1"

  # The master password to protect the confidential configuration data on the PLC
  # It has been added as variable to this document so that it can be used in the following scripts.
  # You should remove it from this document after running the scripts before making your project available to others.
  # Alternatively, you can completely dispense with the scripts contained in this document and enter all relevant commands directly in the terminal.
  # Another alternative is to create the variables as environment variables in your local host system. You can then remove the definition from this document and still use the prepared scripts.
  # Please use a password that is case sensitive (1 big and 1 small letter), a special character and a number.
  # DISCLAIMER: Storing and publishing passwords in readable form is not recommended
  MASTER_PW: ""

  # Defining OPC-UA port for the certficate.
  OPC_UA_PORT: "4840"

  # Defining alternative dns for the certficate.
  DNS: "myplc.example.com"

  # The locations of the certificate files.
  TLS_CONNECT_CERTFILE: "certificate/reference_x509.crt"
  TLS_IMPORT_CERTFILE: "certificate/containerWithPublicAndPrivateKeys_x509.p12"

  # The password (or passphrase) to access containerWithPublicAndPrivateKeys_x509.p12 used when importing the certificate
  # DISCLAIMER: Storing and publishing passphrase in readable form is not recommended
  CERT_PASSPHRASE: ""

  # The name of the PLC as specified in the PLC configuration
  # The name should be specified before creating the PLC's security file, as the file are assigned using the PLC name.
  PLC_NAME: "PLC_1"

  # Ordernumber and version of the PLC for generating the template file.
  PLC_ORDERNUMBER: "6ES7 516-3AP03-0AB0"
  PLC_VERSION: "V4.0"

  # The user name as specified in the PLC configuration.
  USER_NAME: "User1"

  # Please also set the password in the file '/.vscode/launch.json' for the debugger.
  # DISCLAIMER: Storing and publishing passwords in readable form is not recommended.
  USER_PASSWORD: ""

# Apax scripts
scripts:
  ########## Please run after filling the variables: 'PLC_NAME', 'PLC_ORDERNUMBER', 'PLC_VERSION' ##########
  # Generates PLC template file from vars 'PLC_ORDERNUMBER' and 'PLC_VERSION'.
  generate_PLC_template:
    - apax hwc generate-template-file --order-number "$PLC_ORDERNUMBER"
      --version "$PLC_VERSION" --output "hwc/templates/MyPlc_Template.hwl.yml"
      --template-name "MyPlc_Template"
  # We provide a Bash function that simplifies certificate creation using OpenSSL and automatically moves the certificate to the designated folder.
  # In order to call the script, the access level must be authorized at the beginning.
  # You need to set the variable CERT_PASSPHRASE before executing the script
  create_certificate:
    - chmod +x certificate/createCertificateViaOpenSSL.sh
    - certificate/createCertificateViaOpenSSL.sh --ip $IP_ADDRESS --uri
      opc.tcp://$IP_ADDRESS:$OPC_UA_PORT --pkcs12-password $CERT_PASSPHRASE
      --dns $DNS
    - echo "Make sure that the CERT_PASSPHRASE variable retains the value that
      was last used to generate the certificate files when you import
      certificates later."
  # Creates a container-file for the PLC security configuration.
  hwc_setup_secure_communication: hwc setup-secure-communication --input hwc
    --module-name $PLC_NAME --master-password $MASTER_PW
  # Imports the certificate for secure communication (TLS: Transport Layer Security) into this project so that it can be loaded onto the PLC. If applicable, repeat the process for other purposes such as the WebServer or OPC UA Server.
  hwc_import_certificate: hwc import-certificate --input hwc --module-name
    $PLC_NAME --certificate $TLS_IMPORT_CERTFILE --passphrase $CERT_PASSPHRASE
    --purpose TLS
  # Adds a user for the PLC.
  hwc_add_user: hwc manage-users --input hwc --module-name $PLC_NAME set-password
    --username $USER_NAME --password $USER_PASSWORD
  ##################################################################################
  # Compiles the hardware description (input: sources) to generate compiled HW artifacts (output: binaries), IO- and HwIdent mapping tables (SystemConstants).
  hw_compile: hwc compile --input hwc --output $HW_BIN_FOLDER
  # Loads the target-specific compiled hardware artifacts onto the PLC.
  hw_load: hwld load --input $HW_BIN_FOLDER/$PLC_NAME --target $IP_ADDRESS
    --accept-security-disclaimer --certificate $TLS_CONNECT_CERTFILE
    --master-password $MASTER_PW --username $USER_NAME --password $USER_PASSWORD
  # Loads the target-specific compiled software artifacts onto the PLC.
  load: sld load --input $SW_BIN_FOLDER --target $IP_ADDRESS --restart
    --accept-security-disclaimer --log debug -C $TLS_CONNECT_CERTFILE --username
    $USER_NAME --password $USER_PASSWORD
  # Builds and download the SW application to the target PLC.
  dlplc:
    - apax build
    - apax load
  # Builds and downloads the HW configuration followed by the SW application.
  compile_and_load_all:
    - apax hw_compile
    - apax hw_load
    - apax dlplc
